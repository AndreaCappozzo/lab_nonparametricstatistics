## ----setup, include=FALSE-----------------------------------------------------------------------------------------------------------
library(rgl)
knitr::opts_chunk$set(echo = TRUE)
knitr::knit_hooks$set(webgl = hook_webgl)


## .extracode {

## background-color: lightblue;

## }


## -----------------------------------------------------------------------------------------------------------------------------------

seed=2781991
B=1000


## -----------------------------------------------------------------------------------------------------------------------------------
data=stabledist::rstable(1000,1.5,0)
hist(data)
median(data)



## -----------------------------------------------------------------------------------------------------------------------------------
median(data)


## -----------------------------------------------------------------------------------------------------------------------------------
uni_t_perm=function(data,mu0,B=1000){

data_trans=data-mu0
T0=abs(mean(data_trans))
T_perm=numeric(B)
n=length(data)

for(perm in 1:B){
  
  refl <- rbinom(n, 1, 0.5)*2 - 1
  T_perm[perm]=abs(median(data_trans*refl))

}
return(sum(T_perm>=T0)/B)
}



## -----------------------------------------------------------------------------------------------------------------------------------
grid=seq(-3,3,by=0.001)
length(grid)


## -----------------------------------------------------------------------------------------------------------------------------------
library(pbapply)
library(parallel)


## -----------------------------------------------------------------------------------------------------------------------------------
detectCores()


## -----------------------------------------------------------------------------------------------------------------------------------

cl=makeCluster(detectCores())



## -----------------------------------------------------------------------------------------------------------------------------------
clusterExport(cl,varlist=list("data","uni_t_perm"))


## -----------------------------------------------------------------------------------------------------------------------------------



perm_wrapper=function(grid_point){uni_t_perm(data,grid_point,B=2000)}
pval_function=pbsapply(grid,perm_wrapper,cl=cl)



## -----------------------------------------------------------------------------------------------------------------------------------
plot(grid,pval_function,type='l')
range(grid[pval_function>0.05])


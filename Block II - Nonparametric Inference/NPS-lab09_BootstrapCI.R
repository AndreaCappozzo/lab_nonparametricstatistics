## ----setup, include=FALSE-----------------------------------------------------------------------------------------------------------
library(rgl)
knitr::opts_chunk$set(echo = TRUE)
knitr::knit_hooks$set(webgl = hook_webgl)


## .extracode {

## background-color: lightblue;

## }


## -----------------------------------------------------------------------------------------------------------------------------------

seed=2781991
B=100000
library(pbapply)
library(parallel)


## -----------------------------------------------------------------------------------------------------------------------------------
set.seed(seed)
x1=stabledist::rstable(1000,1.8,0)

# Plot data
hist(x1)
boxplot(x1, main = 'X1')


## -----------------------------------------------------------------------------------------------------------------------------------
T.obs <- median(x1)
T.obs


## -----------------------------------------------------------------------------------------------------------------------------------
cl=makeCluster(parallel::detectCores())
clusterExport(cl=cl,list('x1'))




## -----------------------------------------------------------------------------------------------------------------------------------
T.boot=pbreplicate(B,median(sample(x1, replace = T)))


## -----------------------------------------------------------------------------------------------------------------------------------
plot(ecdf(T.boot), main='Sample median')
abline(v = T.obs, lty=2)


## -----------------------------------------------------------------------------------------------------------------------------------
var=var(T.boot)
var
bias=mean(T.boot)-T.obs
bias
RMSE=sqrt(var+bias^2)
RMSE



## -----------------------------------------------------------------------------------------------------------------------------------

alpha <- 0.05

right.quantile <- quantile(T.boot, 1 - alpha/2)
left.quantile  <- quantile(T.boot, alpha/2)



CI.RP <- c(T.obs - (right.quantile - T.obs), T.obs - (left.quantile - T.obs))
names(CI.RP)=c('lwr','upr')

plot(ecdf(T.boot), main='Sample median')
abline(v = T.obs, lty=2)
abline(v = CI.RP)


## -----------------------------------------------------------------------------------------------------------------------------------
alpha_grid=seq(0.001,0.5,by=0.001)
length(alpha_grid)


## -----------------------------------------------------------------------------------------------------------------------------------
CI_calc=function(alpha_level){
  right.quantile <- quantile(T.boot, 1 - alpha_level/2)
  left.quantile  <- quantile(T.boot, alpha_level/2)
  out=c(T.obs - (right.quantile - T.obs), T.obs - (left.quantile - T.obs))
  names(out)=c('lwr','upr')
  return(out)
}


## -----------------------------------------------------------------------------------------------------------------------------------
CI_list=pblapply(alpha_grid,CI_calc)
CI_mat=dplyr::bind_rows(CI_list)


## -----------------------------------------------------------------------------------------------------------------------------------
check=CI_mat[,1]>0 | CI_mat[,2]<0
(alpha_grid[check])[1]

